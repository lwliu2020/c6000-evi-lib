<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>C6000-evi-lib: xprintf.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript">
$(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">C6000-evi-lib</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('xprintf_8c.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">xprintf.c</div>  </div>
</div>
<div class="contents">
<a href="xprintf_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00010"></a>00010 <span class="preprocessor">#include &quot;<a class="code" href="xprintf_8h.html" title="Define some prototypes of functions that use stdarg to parse input arguments, dump character out outp...">xprintf.h</a>&quot;</span>
<a name="l00011"></a>00011 
<a name="l00012"></a>00012 
<a name="l00013"></a>00013 <span class="preprocessor">#if _USE_XFUNC_OUT</span>
<a name="l00014"></a>00014 <span class="preprocessor"></span>
<a name="l00015"></a><a class="code" href="xprintf_8h.html#a252bd1441053105ef196c509327ef009">00015</a> void (*<a class="code" href="xprintf_8c.html#a252bd1441053105ef196c509327ef009">xfunc_out</a>)(<span class="keywordtype">unsigned</span> char);   <span class="comment">/* Pointer to the output stream */</span>
<a name="l00016"></a><a class="code" href="xprintf_8c.html#a2db6321d794195ebda3bbaf17a3f06f9">00016</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="xprintf_8c.html#a2db6321d794195ebda3bbaf17a3f06f9">outptr</a>=0;
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 <span class="comment">/*----------------------------------------------*/</span>
<a name="l00019"></a>00019 <span class="comment">/* Put a character                              */</span>
<a name="l00020"></a>00020 <span class="comment">/*----------------------------------------------*/</span>
<a name="l00021"></a>00021 
<a name="l00022"></a><a class="code" href="xprintf_8h.html#abe28f23fe608473b7842698f58d3383e">00022</a> <span class="keywordtype">void</span> <a class="code" href="xprintf_8c.html#abe28f23fe608473b7842698f58d3383e">xputc</a> (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> c)
<a name="l00023"></a>00023 {
<a name="l00024"></a>00024     <span class="keywordflow">if</span> (<a class="code" href="xprintf_8h.html#a81095ef4440d4aaa43747394f9ee54f3">_CR_CRLF</a> &amp;&amp; c == <span class="charliteral">&#39;\n&#39;</span>) <a class="code" href="xprintf_8c.html#abe28f23fe608473b7842698f58d3383e">xputc</a>(<span class="charliteral">&#39;\r&#39;</span>);     <span class="comment">/* CR -&gt; CRLF */</span>
<a name="l00025"></a>00025     <span class="keywordflow">if</span> (<a class="code" href="xprintf_8c.html#a252bd1441053105ef196c509327ef009">xfunc_out</a>){
<a name="l00026"></a>00026         <a class="code" href="xprintf_8c.html#a252bd1441053105ef196c509327ef009">xfunc_out</a>((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)c);
<a name="l00027"></a>00027     }
<a name="l00028"></a>00028 }
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 <span class="comment">/*----------------------------------------------*/</span>
<a name="l00033"></a>00033 <span class="comment">/* Put a null-terminated string                 */</span>
<a name="l00034"></a>00034 <span class="comment">/*----------------------------------------------*/</span>
<a name="l00035"></a>00035 
<a name="l00036"></a><a class="code" href="xprintf_8h.html#a559e5536b6c450407a6fa024c4cc8644">00036</a> <span class="keywordtype">void</span> <a class="code" href="xprintf_8c.html#a559e5536b6c450407a6fa024c4cc8644">xputs</a> (                    <span class="comment">/* Put a string to the default device */</span>
<a name="l00037"></a>00037     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* str                <span class="comment">/* Pointer to the string */</span>
<a name="l00038"></a>00038 )
<a name="l00039"></a>00039 {
<a name="l00040"></a>00040     <span class="keywordflow">while</span> (*str)
<a name="l00041"></a>00041         <a class="code" href="xprintf_8c.html#abe28f23fe608473b7842698f58d3383e">xputc</a>(*str++);
<a name="l00042"></a>00042 }
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 
<a name="l00045"></a><a class="code" href="xprintf_8h.html#ae55fc50e5794dc959b3ee063571cc674">00045</a> <span class="keywordtype">void</span> <a class="code" href="xprintf_8c.html#ae55fc50e5794dc959b3ee063571cc674">xfputs</a> (                   <span class="comment">/* Put a string to the specified device */</span>
<a name="l00046"></a>00046     <span class="keywordtype">void</span>(*func)(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>), <span class="comment">/* Pointer to the output function */</span>
<a name="l00047"></a>00047     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*    str             <span class="comment">/* Pointer to the string */</span>
<a name="l00048"></a>00048 )
<a name="l00049"></a>00049 {
<a name="l00050"></a>00050     void (*pf)(<span class="keywordtype">unsigned</span> char);
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 
<a name="l00053"></a>00053     pf = <a class="code" href="xprintf_8c.html#a252bd1441053105ef196c509327ef009">xfunc_out</a>;     <span class="comment">/* Save current output device */</span>
<a name="l00054"></a>00054     <a class="code" href="xprintf_8c.html#a252bd1441053105ef196c509327ef009">xfunc_out</a> = func;   <span class="comment">/* Switch output to specified device */</span>
<a name="l00055"></a>00055     <span class="keywordflow">while</span> (*str)        <span class="comment">/* Put the string */</span>
<a name="l00056"></a>00056         <a class="code" href="xprintf_8c.html#abe28f23fe608473b7842698f58d3383e">xputc</a>(*str++);
<a name="l00057"></a>00057     <a class="code" href="xprintf_8c.html#a252bd1441053105ef196c509327ef009">xfunc_out</a> = pf;     <span class="comment">/* Restore output device */</span>
<a name="l00058"></a>00058 }
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 
<a name="l00061"></a>00061 
<a name="l00062"></a>00062 <span class="comment">/*----------------------------------------------*/</span>
<a name="l00063"></a>00063 <span class="comment">/* Formatted string output                      */</span>
<a name="l00064"></a>00064 <span class="comment">/*----------------------------------------------*/</span>
<a name="l00065"></a>00065 <span class="comment">/*  xprintf(&quot;%d&quot;, 1234);            &quot;1234&quot;</span>
<a name="l00066"></a>00066 <span class="comment">    xprintf(&quot;%6d,%3d%%&quot;, -200, 5);  &quot;  -200,  5%&quot;</span>
<a name="l00067"></a>00067 <span class="comment">    xprintf(&quot;%-6u&quot;, 100);           &quot;100   &quot;</span>
<a name="l00068"></a>00068 <span class="comment">    xprintf(&quot;%ld&quot;, 12345678L);      &quot;12345678&quot;</span>
<a name="l00069"></a>00069 <span class="comment">    xprintf(&quot;%04x&quot;, 0xA3);          &quot;00a3&quot;</span>
<a name="l00070"></a>00070 <span class="comment">    xprintf(&quot;%08LX&quot;, 0x123ABC);     &quot;00123ABC&quot;</span>
<a name="l00071"></a>00071 <span class="comment">    xprintf(&quot;%016b&quot;, 0x550F);       &quot;0101010100001111&quot;</span>
<a name="l00072"></a>00072 <span class="comment">    xprintf(&quot;%s&quot;, &quot;String&quot;);        &quot;String&quot;</span>
<a name="l00073"></a>00073 <span class="comment">    xprintf(&quot;%-4s&quot;, &quot;abc&quot;);         &quot;abc &quot;</span>
<a name="l00074"></a>00074 <span class="comment">    xprintf(&quot;%4s&quot;, &quot;abc&quot;);          &quot; abc&quot;</span>
<a name="l00075"></a>00075 <span class="comment">    xprintf(&quot;%c&quot;, &#39;a&#39;);             &quot;a&quot;</span>
<a name="l00076"></a>00076 <span class="comment">    xprintf(&quot;%f&quot;, 10.0);            &lt;xprintf lacks floating point support&gt;</span>
<a name="l00077"></a>00077 <span class="comment">*/</span>
<a name="l00078"></a>00078 
<a name="l00079"></a>00079 <span class="comment">//static</span>
<a name="l00080"></a><a class="code" href="xprintf_8h.html#aa2a911de539b897141dd79e77fcb75ae">00080</a> <span class="keywordtype">void</span> <a class="code" href="xprintf_8c.html#aa2a911de539b897141dd79e77fcb75ae">xvprintf</a> (
<a name="l00081"></a>00081     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*    fmt,    <span class="comment">/* Pointer to the format string */</span>
<a name="l00082"></a>00082     va_list arp         <span class="comment">/* Pointer to arguments */</span>
<a name="l00083"></a>00083 )
<a name="l00084"></a>00084 {
<a name="l00085"></a>00085     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> r, i, j, w, f;
<a name="l00086"></a>00086     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> v;
<a name="l00087"></a>00087     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> s[16], c, d, *p;
<a name="l00088"></a>00088 
<a name="l00089"></a>00089     <span class="comment">//uart1_sendchar(0xdd);</span>
<a name="l00090"></a>00090     <span class="keywordflow">for</span> (;;) {
<a name="l00091"></a>00091         c = *fmt++;                 <span class="comment">/* Get a char */</span>
<a name="l00092"></a>00092         <span class="keywordflow">if</span> (!c) <span class="keywordflow">break</span>;              <span class="comment">/* End of format? */</span>
<a name="l00093"></a>00093         <span class="keywordflow">if</span> (c != <span class="charliteral">&#39;%&#39;</span>) {             <span class="comment">/* Pass through it if not a % sequense */</span>
<a name="l00094"></a>00094             <a class="code" href="xprintf_8c.html#abe28f23fe608473b7842698f58d3383e">xputc</a>(c); <span class="keywordflow">continue</span>;
<a name="l00095"></a>00095         }
<a name="l00096"></a>00096         f = 0;
<a name="l00097"></a>00097         c = *fmt++;                 <span class="comment">/* Get first char of the sequense */</span>
<a name="l00098"></a>00098         <span class="keywordflow">if</span> (c == <span class="charliteral">&#39;0&#39;</span>) {             <span class="comment">/* Flag: &#39;0&#39; padded */</span>
<a name="l00099"></a>00099             f = 1; c = *fmt++;
<a name="l00100"></a>00100         } <span class="keywordflow">else</span> {
<a name="l00101"></a>00101             <span class="keywordflow">if</span> (c == <span class="charliteral">&#39;-&#39;</span>) {         <span class="comment">/* Flag: left justified */</span>
<a name="l00102"></a>00102                 f = 2; c = *fmt++;
<a name="l00103"></a>00103             }
<a name="l00104"></a>00104         }
<a name="l00105"></a>00105         <span class="keywordflow">for</span> (w = 0; c &gt;= <span class="charliteral">&#39;0&#39;</span> &amp;&amp; c &lt;= <span class="charliteral">&#39;9&#39;</span>; c = *fmt++)   <span class="comment">/* Minimum width */</span>
<a name="l00106"></a>00106             w = w * 10 + c - <span class="charliteral">&#39;0&#39;</span>;
<a name="l00107"></a>00107         <span class="keywordflow">if</span> (c == <span class="charliteral">&#39;l&#39;</span> || c == <span class="charliteral">&#39;L&#39;</span>) { <span class="comment">/* Prefix: Size is long int */</span>
<a name="l00108"></a>00108             f |= 4; c = *fmt++;
<a name="l00109"></a>00109         }
<a name="l00110"></a>00110         <span class="keywordflow">if</span> (!c) <span class="keywordflow">break</span>;              <span class="comment">/* End of format? */</span>
<a name="l00111"></a>00111         d = c;
<a name="l00112"></a>00112         <span class="keywordflow">if</span> (d &gt;= <span class="charliteral">&#39;a&#39;</span>) d -= 0x20;
<a name="l00113"></a>00113         <span class="keywordflow">switch</span> (d) {                <span class="comment">/* Type is... */</span>
<a name="l00114"></a>00114         <span class="keywordflow">case</span> <span class="charliteral">&#39;S&#39;</span> :                  <span class="comment">/* String */</span>
<a name="l00115"></a>00115             p = va_arg(arp, <span class="keywordtype">char</span>*);
<a name="l00116"></a>00116             <span class="keywordflow">for</span> (j = 0; p[j]; j++) ;
<a name="l00117"></a>00117             <span class="keywordflow">while</span> (!(f &amp; 2) &amp;&amp; j++ &lt; w) <a class="code" href="xprintf_8c.html#abe28f23fe608473b7842698f58d3383e">xputc</a>(<span class="charliteral">&#39; &#39;</span>);
<a name="l00118"></a>00118             <a class="code" href="xprintf_8c.html#a559e5536b6c450407a6fa024c4cc8644">xputs</a>(p);
<a name="l00119"></a>00119             <span class="keywordflow">while</span> (j++ &lt; w) <a class="code" href="xprintf_8c.html#abe28f23fe608473b7842698f58d3383e">xputc</a>(<span class="charliteral">&#39; &#39;</span>);
<a name="l00120"></a>00120             <span class="keywordflow">continue</span>;
<a name="l00121"></a>00121         <span class="keywordflow">case</span> <span class="charliteral">&#39;C&#39;</span> :                  <span class="comment">/* Character */</span>
<a name="l00122"></a>00122             <a class="code" href="xprintf_8c.html#abe28f23fe608473b7842698f58d3383e">xputc</a>((<span class="keywordtype">char</span>)va_arg(arp, <span class="keywordtype">int</span>)); <span class="keywordflow">continue</span>;
<a name="l00123"></a>00123         <span class="keywordflow">case</span> <span class="charliteral">&#39;B&#39;</span> :                  <span class="comment">/* Binary */</span>
<a name="l00124"></a>00124             r = 2; <span class="keywordflow">break</span>;
<a name="l00125"></a>00125         <span class="keywordflow">case</span> <span class="charliteral">&#39;O&#39;</span> :                  <span class="comment">/* Octal */</span>
<a name="l00126"></a>00126             r = 8; <span class="keywordflow">break</span>;
<a name="l00127"></a>00127         <span class="keywordflow">case</span> <span class="charliteral">&#39;D&#39;</span> :                  <span class="comment">/* Signed decimal */</span>
<a name="l00128"></a>00128         <span class="keywordflow">case</span> <span class="charliteral">&#39;U&#39;</span> :                  <span class="comment">/* Unsigned decimal */</span>
<a name="l00129"></a>00129             r = 10; <span class="keywordflow">break</span>;
<a name="l00130"></a>00130         <span class="keywordflow">case</span> <span class="charliteral">&#39;X&#39;</span> :                  <span class="comment">/* Hexdecimal */</span>
<a name="l00131"></a>00131             r = 16; <span class="keywordflow">break</span>;
<a name="l00132"></a>00132         <span class="keywordflow">default</span>:                    <span class="comment">/* Unknown type (passthrough) */</span>
<a name="l00133"></a>00133             <a class="code" href="xprintf_8c.html#abe28f23fe608473b7842698f58d3383e">xputc</a>(c); <span class="keywordflow">continue</span>;
<a name="l00134"></a>00134         }
<a name="l00135"></a>00135 
<a name="l00136"></a>00136         <span class="comment">/* Get an argument and put it in numeral */</span>
<a name="l00137"></a>00137         v = (f &amp; 4) ? va_arg(arp, <span class="keywordtype">long</span>) : ((d == <span class="charliteral">&#39;D&#39;</span>) ? (<span class="keywordtype">long</span>)va_arg(arp, <span class="keywordtype">int</span>) : (long)va_arg(arp, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>));
<a name="l00138"></a>00138         <span class="keywordflow">if</span> (d == <span class="charliteral">&#39;D&#39;</span> &amp;&amp; (v &amp; 0x80000000)) {
<a name="l00139"></a>00139             v = 0 - v;
<a name="l00140"></a>00140             f |= 8;
<a name="l00141"></a>00141         }
<a name="l00142"></a>00142         i = 0;
<a name="l00143"></a>00143         <span class="keywordflow">do</span> {
<a name="l00144"></a>00144             d = (char)(v % r); v /= r;
<a name="l00145"></a>00145             <span class="keywordflow">if</span> (d &gt; 9) d += (c == <span class="charliteral">&#39;x&#39;</span>) ? 0x27 : 0x07;
<a name="l00146"></a>00146             s[i++] = d + <span class="charliteral">&#39;0&#39;</span>;
<a name="l00147"></a>00147         } <span class="keywordflow">while</span> (v &amp;&amp; i &lt; <span class="keyword">sizeof</span>(s));
<a name="l00148"></a>00148         <span class="keywordflow">if</span> (f &amp; 8) s[i++] = <span class="charliteral">&#39;-&#39;</span>;
<a name="l00149"></a>00149         j = i; d = (f &amp; 1) ? <span class="charliteral">&#39;0&#39;</span> : <span class="charliteral">&#39; &#39;</span>;
<a name="l00150"></a>00150         <span class="keywordflow">while</span> (!(f &amp; 2) &amp;&amp; j++ &lt; w) <a class="code" href="xprintf_8c.html#abe28f23fe608473b7842698f58d3383e">xputc</a>(d);
<a name="l00151"></a>00151         <span class="keywordflow">do</span> <a class="code" href="xprintf_8c.html#abe28f23fe608473b7842698f58d3383e">xputc</a>(s[--i]); <span class="keywordflow">while</span>(i);
<a name="l00152"></a>00152         <span class="keywordflow">while</span> (j++ &lt; w) <a class="code" href="xprintf_8c.html#abe28f23fe608473b7842698f58d3383e">xputc</a>(<span class="charliteral">&#39; &#39;</span>);
<a name="l00153"></a>00153     }
<a name="l00154"></a>00154 }
<a name="l00155"></a>00155 
<a name="l00156"></a>00156 
<a name="l00157"></a><a class="code" href="xprintf_8h.html#a7e596e4b974084c4869b8466ca8e66c2">00157</a> <span class="keywordtype">void</span> <a class="code" href="xprintf_8c.html#a7e596e4b974084c4869b8466ca8e66c2">xprintf</a> (          <span class="comment">/* Put a formatted string to the default device */</span>
<a name="l00158"></a>00158     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*    fmt,    <span class="comment">/* Pointer to the format string */</span>
<a name="l00159"></a>00159     ...                 <span class="comment">/* Optional arguments */</span>
<a name="l00160"></a>00160 )
<a name="l00161"></a>00161 {
<a name="l00162"></a>00162     va_list arp;
<a name="l00163"></a>00163     va_start(arp, fmt);
<a name="l00164"></a>00164     <a class="code" href="xprintf_8c.html#aa2a911de539b897141dd79e77fcb75ae">xvprintf</a>(fmt, arp);
<a name="l00165"></a>00165     va_end(arp);
<a name="l00166"></a>00166 }
<a name="l00167"></a>00167 
<a name="l00168"></a>00168 
<a name="l00169"></a><a class="code" href="xprintf_8h.html#a384058b26f2f038adffac62ba994ef0c">00169</a> <span class="keywordtype">void</span> <a class="code" href="xprintf_8c.html#a384058b26f2f038adffac62ba994ef0c">xsprintf</a> (         <span class="comment">/* Put a formatted string to the memory */</span>
<a name="l00170"></a>00170     <span class="keywordtype">char</span>* buff,         <span class="comment">/* Pointer to the output buffer */</span>
<a name="l00171"></a>00171     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*    fmt,    <span class="comment">/* Pointer to the format string */</span>
<a name="l00172"></a>00172     ...                 <span class="comment">/* Optional arguments */</span>
<a name="l00173"></a>00173 )
<a name="l00174"></a>00174 {
<a name="l00175"></a>00175     va_list arp;
<a name="l00176"></a>00176 
<a name="l00177"></a>00177 
<a name="l00178"></a>00178     <a class="code" href="xprintf_8c.html#a2db6321d794195ebda3bbaf17a3f06f9">outptr</a> = buff;      <span class="comment">/* Switch destination for memory */</span>
<a name="l00179"></a>00179 
<a name="l00180"></a>00180     va_start(arp, fmt);
<a name="l00181"></a>00181     <a class="code" href="xprintf_8c.html#aa2a911de539b897141dd79e77fcb75ae">xvprintf</a>(fmt, arp);
<a name="l00182"></a>00182     va_end(arp);
<a name="l00183"></a>00183 
<a name="l00184"></a>00184     *<a class="code" href="xprintf_8c.html#a2db6321d794195ebda3bbaf17a3f06f9">outptr</a> = 0;        <span class="comment">/* Terminate output string with a \0 */</span>
<a name="l00185"></a>00185     <a class="code" href="xprintf_8c.html#a2db6321d794195ebda3bbaf17a3f06f9">outptr</a> = 0;         <span class="comment">/* Switch destination for device */</span>
<a name="l00186"></a>00186 }
<a name="l00187"></a>00187 
<a name="l00188"></a>00188 
<a name="l00189"></a><a class="code" href="xprintf_8h.html#adc662f6eeb90710b924ad9257ae6d064">00189</a> <span class="keywordtype">void</span> <a class="code" href="xprintf_8c.html#adc662f6eeb90710b924ad9257ae6d064">xfprintf</a> (                 <span class="comment">/* Put a formatted string to the specified device */</span>
<a name="l00190"></a>00190     <span class="keywordtype">void</span>(*func)(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>), <span class="comment">/* Pointer to the output function */</span>
<a name="l00191"></a>00191     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*    fmt,            <span class="comment">/* Pointer to the format string */</span>
<a name="l00192"></a>00192     ...                         <span class="comment">/* Optional arguments */</span>
<a name="l00193"></a>00193 )
<a name="l00194"></a>00194 {
<a name="l00195"></a>00195     va_list arp;
<a name="l00196"></a>00196     void (*pf)(<span class="keywordtype">unsigned</span> char);
<a name="l00197"></a>00197 
<a name="l00198"></a>00198 
<a name="l00199"></a>00199     pf = <a class="code" href="xprintf_8c.html#a252bd1441053105ef196c509327ef009">xfunc_out</a>;     <span class="comment">/* Save current output device */</span>
<a name="l00200"></a>00200     <a class="code" href="xprintf_8c.html#a252bd1441053105ef196c509327ef009">xfunc_out</a> = func;   <span class="comment">/* Switch output to specified device */</span>
<a name="l00201"></a>00201 
<a name="l00202"></a>00202     va_start(arp, fmt);
<a name="l00203"></a>00203     <a class="code" href="xprintf_8c.html#aa2a911de539b897141dd79e77fcb75ae">xvprintf</a>(fmt, arp);
<a name="l00204"></a>00204     va_end(arp);
<a name="l00205"></a>00205 
<a name="l00206"></a>00206     <a class="code" href="xprintf_8c.html#a252bd1441053105ef196c509327ef009">xfunc_out</a> = pf;     <span class="comment">/* Restore output device */</span>
<a name="l00207"></a>00207 }
<a name="l00208"></a>00208 
<a name="l00209"></a>00209 
<a name="l00210"></a>00210 
<a name="l00211"></a>00211 <span class="comment">/*----------------------------------------------*/</span>
<a name="l00212"></a>00212 <span class="comment">/* Dump a line of binary dump                   */</span>
<a name="l00213"></a>00213 <span class="comment">/*----------------------------------------------*/</span>
<a name="l00214"></a>00214 
<a name="l00215"></a><a class="code" href="xprintf_8h.html#ad2c6599f0e8866249ff5c40d4adb955e">00215</a> <span class="keywordtype">void</span> <a class="code" href="xprintf_8c.html#ad2c6599f0e8866249ff5c40d4adb955e">put_dump</a> (
<a name="l00216"></a>00216     <span class="keyword">const</span> <span class="keywordtype">void</span>* buff,       <span class="comment">/* Pointer to the array to be dumped */</span>
<a name="l00217"></a>00217     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> addr,     <span class="comment">/* Heading address value */</span>
<a name="l00218"></a>00218     <span class="keywordtype">int</span> len,                <span class="comment">/* Number of items to be dumped */</span>
<a name="l00219"></a>00219     <span class="keywordtype">int</span> width               <span class="comment">/* Size of the items (DW_CHAR, DW_SHORT, DW_LONG) */</span>
<a name="l00220"></a>00220 )
<a name="l00221"></a>00221 {
<a name="l00222"></a>00222     <span class="keywordtype">int</span> i;
<a name="l00223"></a>00223     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *bp;
<a name="l00224"></a>00224     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *sp;
<a name="l00225"></a>00225     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *lp;
<a name="l00226"></a>00226 
<a name="l00227"></a>00227 
<a name="l00228"></a>00228     <a class="code" href="xprintf_8c.html#a7e596e4b974084c4869b8466ca8e66c2">xprintf</a>(<span class="stringliteral">&quot;%08lX &quot;</span>, addr);        <span class="comment">/* address */</span>
<a name="l00229"></a>00229 
<a name="l00230"></a>00230     <span class="keywordflow">switch</span> (width) {
<a name="l00231"></a>00231     <span class="keywordflow">case</span> <a class="code" href="xprintf_8h.html#ab89c99e1e6be944572d237e22ab31dea">DW_CHAR</a>:
<a name="l00232"></a>00232         bp = buff;
<a name="l00233"></a>00233         <span class="keywordflow">for</span> (i = 0; i &lt; len; i++)       <span class="comment">/* Hexdecimal dump */</span>
<a name="l00234"></a>00234             <a class="code" href="xprintf_8c.html#a7e596e4b974084c4869b8466ca8e66c2">xprintf</a>(<span class="stringliteral">&quot; %02X&quot;</span>, bp[i]);
<a name="l00235"></a>00235         <a class="code" href="xprintf_8c.html#abe28f23fe608473b7842698f58d3383e">xputc</a>(<span class="charliteral">&#39; &#39;</span>);
<a name="l00236"></a>00236         <span class="keywordflow">for</span> (i = 0; i &lt; len; i++)       <span class="comment">/* ASCII dump */</span>
<a name="l00237"></a>00237             <a class="code" href="xprintf_8c.html#abe28f23fe608473b7842698f58d3383e">xputc</a>((bp[i] &gt;= <span class="charliteral">&#39; &#39;</span> &amp;&amp; bp[i] &lt;= <span class="charliteral">&#39;~&#39;</span>) ? bp[i] : <span class="charliteral">&#39;.&#39;</span>);
<a name="l00238"></a>00238         <span class="keywordflow">break</span>;
<a name="l00239"></a>00239     <span class="keywordflow">case</span> <a class="code" href="xprintf_8h.html#a65abd5a6b15f17e5cff7cd8701815562">DW_SHORT</a>:
<a name="l00240"></a>00240         sp = buff;
<a name="l00241"></a>00241         <span class="keywordflow">do</span>                              <span class="comment">/* Hexdecimal dump */</span>
<a name="l00242"></a>00242             <a class="code" href="xprintf_8c.html#a7e596e4b974084c4869b8466ca8e66c2">xprintf</a>(<span class="stringliteral">&quot; %04X&quot;</span>, *sp++);
<a name="l00243"></a>00243         <span class="keywordflow">while</span> (--len);
<a name="l00244"></a>00244         <span class="keywordflow">break</span>;
<a name="l00245"></a>00245     <span class="keywordflow">case</span> <a class="code" href="xprintf_8h.html#a0faf0d2cab35cdd2e6c9acddb2a30cd3">DW_LONG</a>:
<a name="l00246"></a>00246         lp = buff;
<a name="l00247"></a>00247         <span class="keywordflow">do</span>                              <span class="comment">/* Hexdecimal dump */</span>
<a name="l00248"></a>00248             <a class="code" href="xprintf_8c.html#a7e596e4b974084c4869b8466ca8e66c2">xprintf</a>(<span class="stringliteral">&quot; %08LX&quot;</span>, *lp++);
<a name="l00249"></a>00249         <span class="keywordflow">while</span> (--len);
<a name="l00250"></a>00250         <span class="keywordflow">break</span>;
<a name="l00251"></a>00251     }
<a name="l00252"></a>00252 
<a name="l00253"></a>00253     <a class="code" href="xprintf_8c.html#abe28f23fe608473b7842698f58d3383e">xputc</a>(<span class="charliteral">&#39;\n&#39;</span>);
<a name="l00254"></a>00254 }
<a name="l00255"></a>00255 
<a name="l00256"></a>00256 <span class="preprocessor">#endif </span><span class="comment">/* _USE_XFUNC_OUT */</span>
<a name="l00257"></a>00257 
<a name="l00258"></a>00258 
<a name="l00259"></a>00259 
<a name="l00260"></a>00260 <span class="preprocessor">#if _USE_XFUNC_IN</span>
<a name="l00261"></a><a class="code" href="xprintf_8h.html#a3549d4e7a6775e876cb29976fe2cedeb">00261</a> <span class="preprocessor"></span><span class="keywordtype">unsigned</span> char (*<a class="code" href="xprintf_8c.html#a3549d4e7a6775e876cb29976fe2cedeb">xfunc_in</a>)(void);    <span class="comment">/* Pointer to the input stream */</span>
<a name="l00262"></a>00262 
<a name="l00263"></a>00263 <span class="comment">/*----------------------------------------------*/</span>
<a name="l00264"></a>00264 <span class="comment">/* Get a line from the input                    */</span>
<a name="l00265"></a>00265 <span class="comment">/*----------------------------------------------*/</span>
<a name="l00266"></a>00266 
<a name="l00267"></a><a class="code" href="xprintf_8h.html#aa123da95b2d021ac920e91b0c3de7783">00267</a> <span class="keywordtype">int</span> <a class="code" href="xprintf_8c.html#aa123da95b2d021ac920e91b0c3de7783">xgets</a> (     <span class="comment">/* 0:End of stream, 1:A line arrived */</span>
<a name="l00268"></a>00268     <span class="keywordtype">char</span>* buff, <span class="comment">/* Pointer to the buffer */</span>
<a name="l00269"></a>00269     <span class="keywordtype">int</span> len     <span class="comment">/* Buffer length */</span>
<a name="l00270"></a>00270 )
<a name="l00271"></a>00271 {
<a name="l00272"></a>00272     <span class="keywordtype">int</span> c, i;
<a name="l00273"></a>00273 
<a name="l00274"></a>00274 
<a name="l00275"></a>00275     <span class="keywordflow">if</span> (!<a class="code" href="xprintf_8c.html#a3549d4e7a6775e876cb29976fe2cedeb">xfunc_in</a>) <span class="keywordflow">return</span> 0;        <span class="comment">/* No input function specified */</span>
<a name="l00276"></a>00276 
<a name="l00277"></a>00277     i = 0;
<a name="l00278"></a>00278     <span class="keywordflow">for</span> (;;) {
<a name="l00279"></a>00279         c = <a class="code" href="xprintf_8c.html#a3549d4e7a6775e876cb29976fe2cedeb">xfunc_in</a>();             <span class="comment">/* Get a char from the incoming stream */</span>
<a name="l00280"></a>00280         <span class="keywordflow">if</span> (!c) <span class="keywordflow">return</span> 0;           <span class="comment">/* End of stream? */</span>
<a name="l00281"></a>00281         <span class="keywordflow">if</span> (c == <span class="charliteral">&#39;\r&#39;</span>) <span class="keywordflow">break</span>;       <span class="comment">/* End of line? */</span>
<a name="l00282"></a>00282         <span class="keywordflow">if</span> (c == <span class="charliteral">&#39;\b&#39;</span> &amp;&amp; i) {       <span class="comment">/* Back space? */</span>
<a name="l00283"></a>00283             i--;
<a name="l00284"></a>00284             <span class="keywordflow">if</span> (<a class="code" href="xprintf_8h.html#aa99cdf8e230567df3ac55cc98e438535">_LINE_ECHO</a>) <a class="code" href="xprintf_8c.html#abe28f23fe608473b7842698f58d3383e">xputc</a>(c);
<a name="l00285"></a>00285             <span class="keywordflow">continue</span>;
<a name="l00286"></a>00286         }
<a name="l00287"></a>00287         <span class="keywordflow">if</span> (c &gt;= <span class="charliteral">&#39; &#39;</span> &amp;&amp; i &lt; len - 1) {  <span class="comment">/* Visible chars */</span>
<a name="l00288"></a>00288             buff[i++] = c;
<a name="l00289"></a>00289             <span class="keywordflow">if</span> (<a class="code" href="xprintf_8h.html#aa99cdf8e230567df3ac55cc98e438535">_LINE_ECHO</a>) <a class="code" href="xprintf_8c.html#abe28f23fe608473b7842698f58d3383e">xputc</a>(c);
<a name="l00290"></a>00290         }
<a name="l00291"></a>00291     }
<a name="l00292"></a>00292     buff[i] = 0;    <span class="comment">/* Terminate with a \0 */</span>
<a name="l00293"></a>00293     <span class="keywordflow">if</span> (<a class="code" href="xprintf_8h.html#aa99cdf8e230567df3ac55cc98e438535">_LINE_ECHO</a>) <a class="code" href="xprintf_8c.html#abe28f23fe608473b7842698f58d3383e">xputc</a>(<span class="charliteral">&#39;\n&#39;</span>);
<a name="l00294"></a>00294     <span class="keywordflow">return</span> 1;
<a name="l00295"></a>00295 }
<a name="l00296"></a>00296 
<a name="l00297"></a>00297 
<a name="l00298"></a><a class="code" href="xprintf_8h.html#acde42e6ae2f8618ecdf340e23675c65f">00298</a> <span class="keywordtype">int</span> <a class="code" href="xprintf_8c.html#acde42e6ae2f8618ecdf340e23675c65f">xfgets</a> (    <span class="comment">/* 0:End of stream, 1:A line arrived */</span>
<a name="l00299"></a>00299     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> (*func)(<span class="keywordtype">void</span>),    <span class="comment">/* Pointer to the input stream function */</span>
<a name="l00300"></a>00300     <span class="keywordtype">char</span>* buff, <span class="comment">/* Pointer to the buffer */</span>
<a name="l00301"></a>00301     <span class="keywordtype">int</span> len     <span class="comment">/* Buffer length */</span>
<a name="l00302"></a>00302 )
<a name="l00303"></a>00303 {
<a name="l00304"></a>00304     <span class="keywordtype">unsigned</span> char (*pf)(void);
<a name="l00305"></a>00305     <span class="keywordtype">int</span> n;
<a name="l00306"></a>00306 
<a name="l00307"></a>00307 
<a name="l00308"></a>00308     pf = <a class="code" href="xprintf_8c.html#a3549d4e7a6775e876cb29976fe2cedeb">xfunc_in</a>;          <span class="comment">/* Save current input device */</span>
<a name="l00309"></a>00309     <a class="code" href="xprintf_8c.html#a3549d4e7a6775e876cb29976fe2cedeb">xfunc_in</a> = func;        <span class="comment">/* Switch input to specified device */</span>
<a name="l00310"></a>00310     n = <a class="code" href="xprintf_8c.html#aa123da95b2d021ac920e91b0c3de7783">xgets</a>(buff, len);   <span class="comment">/* Get a line */</span>
<a name="l00311"></a>00311     <a class="code" href="xprintf_8c.html#a3549d4e7a6775e876cb29976fe2cedeb">xfunc_in</a> = pf;          <span class="comment">/* Restore input device */</span>
<a name="l00312"></a>00312 
<a name="l00313"></a>00313     <span class="keywordflow">return</span> n;
<a name="l00314"></a>00314 }
<a name="l00315"></a>00315 
<a name="l00316"></a>00316 
<a name="l00317"></a>00317 <span class="comment">/*----------------------------------------------*/</span>
<a name="l00318"></a>00318 <span class="comment">/* Get a value of the string                    */</span>
<a name="l00319"></a>00319 <span class="comment">/*----------------------------------------------*/</span>
<a name="l00320"></a>00320 <span class="comment">/*  &quot;123 -5   0x3ff 0b1111 0377  w &quot;</span>
<a name="l00321"></a>00321 <span class="comment">        ^                           1st call returns 123 and next ptr</span>
<a name="l00322"></a>00322 <span class="comment">           ^                        2nd call returns -5 and next ptr</span>
<a name="l00323"></a>00323 <span class="comment">                   ^                3rd call returns 1023 and next ptr</span>
<a name="l00324"></a>00324 <span class="comment">                          ^         4th call returns 15 and next ptr</span>
<a name="l00325"></a>00325 <span class="comment">                               ^    5th call returns 255 and next ptr</span>
<a name="l00326"></a>00326 <span class="comment">                                  ^ 6th call fails and returns 0</span>
<a name="l00327"></a>00327 <span class="comment">*/</span>
<a name="l00328"></a>00328 
<a name="l00329"></a><a class="code" href="xprintf_8h.html#a7c2f5ef0a6ad47d7798ecd31e9891afa">00329</a> <span class="keywordtype">int</span> <a class="code" href="xprintf_8c.html#a7c2f5ef0a6ad47d7798ecd31e9891afa">xatoi</a> (         <span class="comment">/* 0:Failed, 1:Successful */</span>
<a name="l00330"></a>00330     <span class="keywordtype">char</span> **str,     <span class="comment">/* Pointer to pointer to the string */</span>
<a name="l00331"></a>00331     <span class="keywordtype">long</span> *res       <span class="comment">/* Pointer to the valiable to store the value */</span>
<a name="l00332"></a>00332 )
<a name="l00333"></a>00333 {
<a name="l00334"></a>00334     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> val;
<a name="l00335"></a>00335     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> c, r, s = 0;
<a name="l00336"></a>00336 
<a name="l00337"></a>00337 
<a name="l00338"></a>00338     *res = 0;
<a name="l00339"></a>00339 
<a name="l00340"></a>00340     <span class="keywordflow">while</span> ((c = **str) == <span class="charliteral">&#39; &#39;</span>) (*str)++;    <span class="comment">/* Skip leading spaces */</span>
<a name="l00341"></a>00341 
<a name="l00342"></a>00342     <span class="keywordflow">if</span> (c == <span class="charliteral">&#39;-&#39;</span>) {     <span class="comment">/* negative? */</span>
<a name="l00343"></a>00343         s = 1;
<a name="l00344"></a>00344         c = *(++(*str));
<a name="l00345"></a>00345     }
<a name="l00346"></a>00346 
<a name="l00347"></a>00347     <span class="keywordflow">if</span> (c == <span class="charliteral">&#39;0&#39;</span>) {
<a name="l00348"></a>00348         c = *(++(*str));
<a name="l00349"></a>00349         <span class="keywordflow">switch</span> (c) {
<a name="l00350"></a>00350         <span class="keywordflow">case</span> <span class="charliteral">&#39;x&#39;</span>:       <span class="comment">/* hexdecimal */</span>
<a name="l00351"></a>00351             r = 16; c = *(++(*str));
<a name="l00352"></a>00352             <span class="keywordflow">break</span>;
<a name="l00353"></a>00353         <span class="keywordflow">case</span> <span class="charliteral">&#39;b&#39;</span>:       <span class="comment">/* binary */</span>
<a name="l00354"></a>00354             r = 2; c = *(++(*str));
<a name="l00355"></a>00355             <span class="keywordflow">break</span>;
<a name="l00356"></a>00356         <span class="keywordflow">default</span>:
<a name="l00357"></a>00357             <span class="keywordflow">if</span> (c &lt;= <span class="charliteral">&#39; &#39;</span>) <span class="keywordflow">return</span> 1; <span class="comment">/* single zero */</span>
<a name="l00358"></a>00358             <span class="keywordflow">if</span> (c &lt; &#39;0&#39; || c &gt; <span class="charliteral">&#39;9&#39;</span>) <span class="keywordflow">return</span> 0;   <span class="comment">/* invalid char */</span>
<a name="l00359"></a>00359             r = 8;      <span class="comment">/* octal */</span>
<a name="l00360"></a>00360         }
<a name="l00361"></a>00361     } <span class="keywordflow">else</span> {
<a name="l00362"></a>00362         <span class="keywordflow">if</span> (c &lt; &#39;0&#39; || c &gt; <span class="charliteral">&#39;9&#39;</span>) <span class="keywordflow">return</span> 0;   <span class="comment">/* EOL or invalid char */</span>
<a name="l00363"></a>00363         r = 10;         <span class="comment">/* decimal */</span>
<a name="l00364"></a>00364     }
<a name="l00365"></a>00365 
<a name="l00366"></a>00366     val = 0;
<a name="l00367"></a>00367     <span class="keywordflow">while</span> (c &gt; <span class="charliteral">&#39; &#39;</span>) {
<a name="l00368"></a>00368         <span class="keywordflow">if</span> (c &gt;= <span class="charliteral">&#39;a&#39;</span>) c -= 0x20;
<a name="l00369"></a>00369         c -= <span class="charliteral">&#39;0&#39;</span>;
<a name="l00370"></a>00370         <span class="keywordflow">if</span> (c &gt;= 17) {
<a name="l00371"></a>00371             c -= 7;
<a name="l00372"></a>00372             <span class="keywordflow">if</span> (c &lt;= 9) <span class="keywordflow">return</span> 0;   <span class="comment">/* invalid char */</span>
<a name="l00373"></a>00373         }
<a name="l00374"></a>00374         <span class="keywordflow">if</span> (c &gt;= r) <span class="keywordflow">return</span> 0;       <span class="comment">/* invalid char for current radix */</span>
<a name="l00375"></a>00375         val = val * r + c;
<a name="l00376"></a>00376         c = *(++(*str));
<a name="l00377"></a>00377     }
<a name="l00378"></a>00378     <span class="keywordflow">if</span> (s) val = 0 - val;           <span class="comment">/* apply sign if needed */</span>
<a name="l00379"></a>00379 
<a name="l00380"></a>00380     *res = val;
<a name="l00381"></a>00381     <span class="keywordflow">return</span> 1;
<a name="l00382"></a>00382 }
<a name="l00383"></a>00383 
<a name="l00384"></a>00384 <span class="preprocessor">#endif </span><span class="comment">/* _USE_XFUNC_IN */</span>
<a name="l00385"></a>00385 
<a name="l00386"></a>00386 
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="xprintf_8c.html">xprintf.c</a>      </li>
      <li class="footer">Generated on Sun May 19 2013 for C6000-evi-lib by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </li>
    </ul>
  </div>

</body>
</html>
